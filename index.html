<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Authentication Required</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
      background-size: 400% 400%;
      animation: aurora 15s ease infinite;
      font-family: "Segoe UI", Arial, sans-serif;
    }
    @keyframes aurora { 0% {background-position:0% 50%;} 50% {background-position:100% 50%;} 100% {background-position:0% 50%;} }
    .glass { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(12px); border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); transition: 0.3s ease; }
    .glass:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0,0,0,0.4); }
    .btn { padding:0.5rem 1.25rem; border-radius:0.5rem; font-weight:600; box-shadow:0 4px 12px rgba(0,0,0,0.2); transition: transform 0.2s, opacity 0.3s; }
    .btn-main { background: linear-gradient(to right, #ff758c, #ff7eb3); color: white; } 
    .btn-main:hover { transform: scale(1.05); } 
    .btn-alt { background: rgba(255,255,255,0.2); color: white; } 
    .btn-alt:hover { transform: scale(1.05); } 
    input:focus { border-color:#ff7eb3; box-shadow:0 0 8px rgba(255,126,179,0.7); outline:none; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:10px; text-align:center; border:1px solid rgba(255,255,255,0.3); }
    th { background: rgba(255,255,255,0.2); color:#fff; }
    tr:hover { background: rgba(255,255,255,0.25); cursor:pointer; transition:0.3s; }
    tr.copied { background: rgba(255,255,255,0.3); color:#222; font-weight:bold; }
    .fade { opacity:0; transition:opacity 0.5s; }
    .fade.show { opacity:1; }
    #loader { display:none; text-align:center; font-weight:bold; margin-top:10px; }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 text-white">

  <!-- Login Screen -->
  <div id="loginScreen" class="glass p-8 w-full max-w-md text-center fade show">
    <h1 class="text-3xl font-bold mb-4">Authentication Required</h1>
    <input type="text" id="userId" placeholder="User ID" class="w-full mb-4 px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/70">
    <input type="password" id="password" placeholder="Password" class="w-full mb-6 px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/70">
    <button onclick="login()" class="btn btn-main w-full mb-2">Login</button>
    <p id="loginMessage" class="mt-4 text-red-200 font-semibold"></p>
  </div>

  <!-- User App Screen -->
  <div id="appScreen" class="glass p-6 w-full max-w-4xl hidden fade">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold">User Dashboard</h2>
      <button onclick="logout()" class="btn btn-alt">Logout</button>
    </div>
    <div class="glass p-4 mb-6">
      <p><b>User Name:</b> Ramurthy-Nagar</p>
      <p><b>Store Code:</b> K322</p>
      <p><b>Status:</b> <span id="statusLabel"></span></p>
    </div>
    <div class="glass p-4 mb-6">
      <h3 class="text-xl mb-4">üìÇ Upload Excel File</h3>
      <input type="file" id="fileInput" accept=".xlsx, .xls" class="mb-4">
      <div class="flex flex-wrap gap-3">
        <button id="generateBtn" onclick="processFile()" disabled class="btn btn-main">Generate Links</button>
        <button onclick="clearData()" class="btn btn-alt">Clear All</button>
        <button id="copyAllBtn" onclick="copyAllLinks()" disabled class="btn btn-alt">Copy All</button>
        <button id="exportBtn" onclick="exportToCSV()" disabled class="btn btn-alt">Export CSV</button>
      </div>
      <div id="loader">‚è≥ Generating Links...</div>
    </div>
    <div class="glass p-4 overflow-x-auto">
      <table id="linkTable">
        <thead>
          <tr><th>Receipt No.</th><th>Sales Type</th><th>Action</th></tr>
        </thead>
        <tbody class="text-black bg-white/60"></tbody>
      </table>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminScreen" class="glass p-6 w-full max-w-3xl hidden fade">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold">üîê Admin Panel</h2>
      <button onclick="logout()" class="btn btn-alt">Logout</button>
    </div>
    <p><b>User:</b> Ramurthy-Nagar (K322)</p>
    <p><b>Status:</b> <span id="adminStatus"></span></p>
    <div class="mt-6 flex gap-4">
      <button onclick="setStatus(true)" class="btn btn-main">Activate User</button>
      <button onclick="setStatus(false)" class="btn btn-alt">Deactivate User</button>
    </div>
  </div>

  <!-- XLSX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Firebase + App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCnFHygIpjdPzF4EaMZoKBzBTpiU0keQw0",
      authDomain: "marvel-be93b.firebaseapp.com",
      projectId: "marvel-be93b",
      storageBucket: "marvel-be93b.appspot.com",
      messagingSenderId: "626647068839",
      appId: "1:626647068839:web:90e88fae52fba975312b82",
      measurementId: "G-V32XBZJZE4",
      databaseURL: "https://marvel-be93b-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storeID = "91KDIPL614-01";
    let currentData = [], copiedLinks = new Set(JSON.parse(localStorage.getItem("copiedLinks") || "[]"));

    function showScreen(id){
      ["loginScreen","appScreen","adminScreen"].forEach(s=>{
        const el=document.getElementById(s);
        el.classList.remove("show"); el.style.display="none";
      });
      const el=document.getElementById(id);
      el.style.display="block";
      setTimeout(()=>el.classList.add("show"),10);
    }

    // --- Login ---
    window.login = function() {
      const userId = document.getElementById("userId").value.trim();
      const password = document.getElementById("password").value.trim();

      // Admin login
      if (userId === "Matrix" && password === "NaveenRusthin@25") {
        showScreen("adminScreen");
        return;
      }

      // Check Firebase user status before allowing login
      const userStatusRef = ref(db, "users/K322/status");
      onValue(userStatusRef, snapshot => {
        const status = snapshot.val() || "inactive";

        if (status === "inactive") {
          document.getElementById("loginMessage").innerText = "‚ö†Ô∏è User is inactive! Contact Admin.";
          return; // Block login entirely
        }

        // Only allow login if user is active
        if (userId && password) {
          showScreen("appScreen");
        } else {
          document.getElementById("loginMessage").innerText = "Invalid credentials!";
        }
      }, { onlyOnce: true });
    };

    window.logout = function(){ showScreen("loginScreen"); };

    // --- Admin Status ---
    window.setStatus = function(active){
      set(ref(db, "users/K322/status"), active ? "active" : "inactive");
      alert(`User status updated to: ${active ? "Active ‚úÖ" : "Inactive ‚ùå"}`);
    };

    // --- Realtime Status Listener ---
    const statusRef = ref(db, "users/K322/status");
    onValue(statusRef, (snapshot)=>{
      const status = snapshot.val() || "inactive";
      document.getElementById("statusLabel").innerText = status==="active"?"‚úÖ Active":"‚ùå Inactive";
      document.getElementById("adminStatus").innerText = status==="active"?"‚úÖ Active":"‚ùå Inactive";

      const fileInput = document.getElementById("fileInput");
      const generateBtn = document.getElementById("generateBtn");
      if(fileInput) fileInput.disabled = status==="inactive";
      if(generateBtn) generateBtn.disabled = status==="inactive";

      if(status==="inactive" && document.getElementById("appScreen").style.display!=="none"){
        alert("‚ö†Ô∏è Your subscription has ended. Contact Admin.");
        logout();
      }
    });

    // --- Excel Helpers ---
    function convertExcelDate(serial){ if(!serial||isNaN(serial)) return ""; const date=new Date((serial-25569)*86400*1000); return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,"0")}-${String(date.getDate()).padStart(2,"0")}`; }
    function convertExcelTime(serial){ if(!serial||isNaN(serial)) return ""; const totalMs=Math.round(serial*24*60*60*1000); const h=String(Math.floor(totalMs/(60*60*1000))).padStart(2,"0"); const m=String(Math.floor((totalMs%(60*60*1000))/(60*1000))).padStart(2,"0"); const s=String(Math.floor((totalMs%(60*1000))/1000)).padStart(2,"0"); return `${h}:${m}:${s}`; }
    function generateSurveyLink(row){
      const receipt=row["Receipt No."], sales=row["Sales Type"];
      let SM="",OI="",OT="";
      if(receipt.startsWith("K322") && sales==="TAKEAWAY"){SM="4.0";OI=receipt.slice(-4);OT="2";}
      else if(receipt.startsWith("K322") && sales==="DINE-IN"){SM="4.0";OI=receipt.slice(-4);OT="1";}
      else if(receipt.startsWith("K322") && sales==="DELIVERY"){SM="3.0";OI=receipt;OT="3";}
      else return null;
      const D=convertExcelDate(row["Date"]);const TM=convertExcelTime(row["Time"]);
      const PH=`91${row["Sell-to Contact No."]}`;const DTM=`${D}T${TM}Z`;const data={"S":storeID,"OI":OI,"D":D,"TM":TM,"DTM":DTM,"TI":OI,"OT":OT,"SM":SM,"PH":PH};
      return `https://customer.kfc-listens.com/jfe/form/SV_8bHC0noyvM3jPWC?Q_EED=${btoa(JSON.stringify(data))}`;
    }

    document.getElementById("fileInput").addEventListener("change",()=>{document.getElementById("generateBtn").disabled=false;});

    window.processFile=function(){
      const file=document.getElementById("fileInput").files[0];if(!file)return;
      document.getElementById("loader").style.display="block";
      const reader=new FileReader();
      reader.onload=function(e){
        const data=new Uint8Array(e.target.result);
        const wb=XLSX.read(data,{type:"array"});
        const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        currentData=rows.map(r=>({...r,link:generateSurveyLink(r)}));
        renderTable();
        document.getElementById("loader").style.display="none";
      };
      reader.readAsArrayBuffer(file);
    };

    function renderTable(){
      const tbody=document.querySelector("#linkTable tbody");tbody.innerHTML="";
      currentData.forEach(row=>{
        if(row.link){
          const tr=document.createElement("tr");
          if(copiedLinks.has(row.link)){
            tr.classList.add("copied");
            tr.innerHTML=`<td>${row["Receipt No."]}</td><td>${row["Sales Type"]}</td><td><button disabled class="btn btn-alt">Copied</button></td>`;
          }else{
            tr.innerHTML=`<td>${row["Receipt No."]}</td><td>${row["Sales Type"]}</td><td><button onclick="copyLink('${row.link}', this)" class="btn btn-main">Copy</button></td>`;
          }
          tbody.appendChild(tr);
        }
      });
      document.getElementById("copyAllBtn").disabled=false;
      document.getElementById("exportBtn").disabled=false;
    }

    window.clearData=function(){currentData=[];document.querySelector("#linkTable tbody").innerHTML="";document.getElementById("copyAllBtn").disabled=true;document.getElementById("exportBtn").disabled=true;};
    window.copyLink=function(link,btn){navigator.clipboard.writeText(link).then(()=>{copiedLinks.add(link);localStorage.setItem("copiedLinks",JSON.stringify([...copiedLinks]));btn.textContent="Copied";btn.disabled=true;btn.closest("tr").classList.add("copied");});};
    window.copyAllLinks=function(){if(currentData.length===0)return alert("No links to copy!");const allLinks=currentData.map(r=>r.link).filter(Boolean).join("\n");navigator.clipboard.writeText(allLinks).then(()=>{currentData.forEach(r=>r.link?copiedLinks.add(r.link):null);localStorage.setItem("copiedLinks",JSON.stringify([...copiedLinks]));renderTable();alert("All links copied!");});};
    window.exportToCSV=function(){let csv="Receipt No.,Sales Type,Generated Link\n";currentData.forEach(r=>r.link?csv+=`${r["Receipt No."]},${r["Sales Type"]},${r.link}\n`:null);const blob=new Blob([csv],{type:"text/csv"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download="survey_links.csv";a.click();};
  </script>
</body>
</html>
